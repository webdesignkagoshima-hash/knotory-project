# お問い合わせフォーム テスト項目

## 新しいディレクトリ構造

```
contact/
├── api/
│   ├── contact.php          # メイン処理API
│   └── get_csrf_token.php   # CSRFトークン発行API
├── config/
│   └── config.php           # 設定ファイル
├── docs/
│   └── TEST_ITEMS.md        # このテスト項目ファイル
├── example/
│   └── index.html           # サンプルフォーム
└── logs/
    ├── access.log           # アクセスログ
    ├── security.log         # セキュリティログ
    └── rate_limit/          # Rate Limitingデータ
```

## 基本機能テスト

### 1. 正常系テスト

#### 1.1 フォーム送信テスト
- [ ] 全ての必須項目を入力してフォーム送信が成功する
- [ ] 自動応答メールが送信者に届く
- [ ] 管理者通知メールが管理者に届く
- [ ] 送信後にフォームがリセットされる
- [ ] 成功メッセージが表示される

#### 1.2 入力値テスト
- [ ] お問い合わせ項目の選択が正しく送信される
- [ ] お名前（日本語・英数字）が正しく送信される
- [ ] メールアドレスが正しく送信される
- [ ] 電話番号（任意項目）が正しく送信される
- [ ] お問い合わせ内容（改行含む）が正しく送信される

#### 1.3 文字エンコーディングテスト
- [ ] 日本語文字が正しく処理される
- [ ] 特殊文字（絵文字等）が適切に処理される
- [ ] 改行コードが正しく処理される

### 2. バリデーションテスト

#### 2.1 必須項目チェック
- [ ] お問い合わせ項目未選択時にエラーが表示される
- [ ] お名前未入力時にエラーが表示される
- [ ] メールアドレス未入力時にエラーが表示される
- [ ] お問い合わせ内容未入力時にエラーが表示される

#### 2.2 形式チェック
- [ ] 不正なメールアドレス形式でエラーが表示される
- [ ] 不正な電話番号形式でエラーが表示される
- [ ] メールアドレスの正規表現パターンマッチング
- [ ] 電話番号の正規表現パターンマッチング

#### 2.3 文字数制限チェック
- [ ] お名前50文字制限の確認
- [ ] お問い合わせ内容2000文字制限の確認
- [ ] 制限超過時の適切なエラーメッセージ表示

## セキュリティテスト

### 3. CSRF攻撃対策テスト

#### 3.1 CSRFトークンテスト
- [ ] CSRFトークン取得API（`../api/get_csrf_token.php`）が正常に動作する
- [ ] トークンなしでのフォーム送信が拒否される
- [ ] 不正なトークンでのフォーム送信が拒否される
- [ ] トークンの有効期限（1時間）チェック
- [ ] 使用済みトークンの再利用が防止される
- [ ] フォーム送信後に新しいトークンが生成される

#### 3.2 CSRFログテスト
- [ ] トークン不一致時のセキュリティログ記録
- [ ] トークン期限切れ時のセキュリティログ記録
- [ ] トークン未送信時のセキュリティログ記録

### 4. Rate Limiting（ブルートフォース攻撃対策）テスト

#### 4.1 レート制限テスト
- [ ] 5分間に5回のリクエスト制限が機能する
- [ ] 制限超過時に429エラーが返される
- [ ] 適切なエラーメッセージが表示される
- [ ] 時間窓経過後にリクエストが再び可能になる
- [ ] IPアドレス別の制限管理が機能する

#### 4.2 Rate Limitingログテスト
- [ ] レート制限超過時のセキュリティログ記録
- [ ] IPアドレス、試行回数、時間窓の記録確認

### 5. ハニーポット対策テスト

#### 5.1 ボット検出テスト
- [ ] websiteフィールドが適切に隠されている
- [ ] websiteフィールドに入力がある場合にボット判定される
- [ ] ボット判定時に成功を装った応答が返される
- [ ] 実際のメール送信が行われない
- [ ] ハニーポット作動時のセキュリティログ記録

### 6. 入力値セキュリティテスト

#### 6.1 XSS攻撃対策テスト
- [ ] `<script>alert('xss')</script>` 入力でXSS攻撃が防がれる
- [ ] `javascript:alert('xss')` 入力が検出される
- [ ] HTMLタグが適切にサニタイズされる
- [ ] 不審なJavaScriptコードの検出ログ記録

#### 6.2 SQLインジェクション対策テスト
- [ ] `'; DROP TABLE users; --` 等のSQL文が検出される
- [ ] `UNION SELECT` 等のSQL文が検出される
- [ ] 不審なSQL文の検出ログ記録

#### 6.3 ディレクトリトラバーサル対策テスト
- [ ] `../../../etc/passwd` 等のパス操作が検出される
- [ ] `/var/log/` 等のシステムパスが検出される
- [ ] 不審なパス操作の検出ログ記録

#### 6.4 コード実行攻撃対策テスト
- [ ] `eval()` 関数の使用が検出される
- [ ] `exec()` 関数の使用が検出される
- [ ] `system()` 関数の使用が検出される

### 7. 入力データサイズ制限テスト

#### 7.1 データサイズテスト
- [ ] 10KB制限を超える大量データの送信が拒否される
- [ ] 制限超過時の適切なエラーメッセージ表示
- [ ] データサイズ超過時のセキュリティログ記録

## CORS（Cross-Origin Resource Sharing）テスト

### 8. CORS設定テスト

#### 8.1 オリジン制御テスト
- [ ] 許可されたドメインからのアクセスが成功する
- [ ] 許可されていないドメインからのアクセスが拒否される
- [ ] localhost/127.0.0.1からの開発環境アクセスが許可される

#### 8.2 プリフライトリクエストテスト
- [ ] OPTIONSリクエストが適切に処理される
- [ ] 適切なCORSヘッダーが返される
- [ ] プリフライトキャッシュが機能する

## ログ機能テスト

### 9. アクセスログテスト

#### 9.1 正常アクセスログ
- [ ] 正常なフォーム送信時に`logs/access.log`に記録される
- [ ] IPアドレス、User-Agent、タイムスタンプが記録される
- [ ] JSON形式でログが出力される

#### 9.2 セキュリティログ
- [ ] セキュリティイベント発生時に`logs/security.log`に記録される
- [ ] 各セキュリティ機能の作動時にログが記録される
- [ ] エラー詳細情報が適切に記録される

### 10. ログローテーションテスト

#### 10.1 ログファイル管理
- [ ] ログファイルが適切に作成される
- [ ] ログファイルの権限が正しく設定されている（644）
- [ ] ログディレクトリの権限が正しく設定されている（755）

## パフォーマンステスト

### 11. レスポンステスト

#### 11.1 応答時間テスト
- [ ] 正常なフォーム送信の応答時間が適切である（<3秒）
- [ ] CSRFトークン取得の応答時間が適切である（<1秒）
- [ ] エラー応答の応答時間が適切である（<1秒）

### 12. 同時アクセステスト

#### 12.1 負荷テスト
- [ ] 複数の同時リクエストが適切に処理される
- [ ] Rate Limitingが同時アクセス時に正しく機能する
- [ ] メール送信が同時実行時に正しく処理される

## 互換性テスト

### 13. ブラウザ互換性テスト

#### 13.1 JavaScript機能テスト
- [ ] Chrome/Edge/Firefox/Safariでの動作確認
- [ ] CSRFトークン取得がすべてのブラウザで動作する
- [ ] フォーム送信処理がすべてのブラウザで動作する

#### 13.2 レスポンシブテスト
- [ ] スマートフォンでの表示・操作確認
- [ ] タブレットでの表示・操作確認

## 本番環境テスト

### 14. サーバー環境テスト

#### 14.1 PHPバージョンテスト
- [ ] 対象PHPバージョンでの動作確認
- [ ] mb_send_mail()関数の動作確認
- [ ] セッション機能の動作確認

#### 14.2 権限・設定テスト
- [ ] ファイル権限の確認
- [ ] logsディレクトリの書き込み権限確認
- [ ] .htaccessの動作確認（config.phpへの直接アクセス制限）

### 15. メール送信テスト

#### 15.1 メール機能テスト
- [ ] 管理者への通知メールが正しく送信される
- [ ] 自動応答メールが正しく送信される
- [ ] メールの文字エンコーディングが正しい
- [ ] メールヘッダーが適切に設定されている
- [ ] 返信先（Reply-To）が正しく設定されている

#### 15.2 メール内容テスト
- [ ] 送信されたデータがメール本文に正しく反映される
- [ ] 日時情報が正しく記録される
- [ ] 改行やフォーマットが適切に処理される

## 運用テスト

### 16. 設定変更テスト

#### 16.1 config.php変更テスト
- [ ] メールアドレス変更が正しく反映される
- [ ] セキュリティ設定変更が正しく反映される
- [ ] CORS設定変更が正しく反映される

#### 16.2 エラーハンドリングテスト
- [ ] 設定ファイル読み込みエラー時の適切な処理
- [ ] メール送信失敗時の適切なエラー処理
- [ ] ログ書き込み失敗時の処理

## 新しいディレクトリ構造でのテスト項目

### 17. パス・ファイル構造テスト

#### 17.1 APIエンドポイントテスト
- [ ] `../api/contact.php` へのPOSTリクエストが正常に処理される
- [ ] `../api/get_csrf_token.php` へのGETリクエストが正常に処理される
- [ ] 相対パスでの設定ファイル読み込みが正常に動作する

#### 17.2 設定ファイルアクセステスト
- [ ] `../config/config.php` が正しく読み込まれる
- [ ] config.phpへの直接ブラウザアクセスが制限されている
- [ ] ログディレクトリのパス解決が正しく動作する

## 注意事項

### テスト実行時の注意点

1. **新しいディレクトリ構造**
   - APIエンドポイントは `api/` ディレクトリ配下
   - 設定ファイルは `config/` ディレクトリ配下
   - サンプルHTMLは `example/` ディレクトリ配下

2. **Rate Limitingテスト**
   - テスト時は制限値を一時的に低く設定することを推奨
   - テスト後は本番設定に戻すことを忘れずに

3. **メール送信テスト**
   - テスト用メールアドレスを使用する
   - 大量のテストメール送信を避ける

4. **ログテスト**
   - テスト前にログファイルをバックアップする
   - テスト後にログファイルを確認する

5. **セキュリティテスト**
   - 実際の攻撃コードは使用せず、安全なテストデータを使用する
   - テスト環境でのみ実行する

6. **本番環境テスト**
   - 十分なテスト後に本番環境にデプロイする
   - 本番環境での初回テストは慎重に行う